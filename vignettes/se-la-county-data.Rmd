---
title: "Reproducing LA County Standard Errors from [@buja2019modelsasapproximationspart1]"
# author: "Riccardo Fogliato, Shamindra Shrotriya"
output: rmarkdown::html_vignette
package: maar    
bibliography: ../inst/REFERENCES.bib
vignette: >
  %\VignetteIndexEntry{Reproducing LA County Standard Errors from [@buja2019modelsasapproximationspart1]}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

``` {r  include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  linewidth = 80,
  fig.align = 'center',
  warning = FALSE,
  message = FALSE
)
```

```{r create_chunk_options, include=FALSE}
source(here::here("R", "scripts_and_filters", "create-chunk-options.R"))
source(here::here("R", "scripts_and_filters", "wrap-lines.R"))
```

## Setup and Installation

First, we'll load the `maar` package, and other `tidyverse` analysis packages.
If you are a new user, you will need to manually run the following commands in a
new in an `R` session before running the vignette code below:

``` {r install_maar, eval=FALSE}
install.packages(pkgs = c("tidyverse", "vroom", "glue", "magrittr", 
                          "knitr", "kableExtra", "remotes"))
remotes::install_github('shamindras/maar', force = TRUE)
```

We will explicitly load the `tidyverse` set of packages to get access to the
`magrittr` pipe (`%>%`) operator.

``` {r load_pkgs}
library(magrittr)
```

For all other functions we will refer to them explicitly using the
`package::function` reference method to avoid ambiguity in the source package of
the specific function used (to avoid function name conflicts).

## Goal of Analysis

We try to replicate the results of Table 1 in
[@buja2019modelsasapproximationspart1], as shown below:

``` {r table1_img, echo=FALSE, fig.cap="Table 1 from [@buja2019modelsasapproximationspart1]", out.width = '90%'}
knitr::include_graphics(here::here("vignettes", "figures", "buja1_table1.png"))
```

## Loading the data

Let's load the LA County Homeless persons data as used in
[@buja2019modelsasapproximationspart1] and briefly examine it.

``` {r load_data}
# LA County source data url, use glue to split string in easy to read format
url_la_county_dat <- glue::glue("http://www-stat.wharton.upenn.edu/~buja",
                                "STAT-961/Homeless_LA_by_Census_Tracts.csv",
                                .sep = "/")

la_county_df <- vroom::vroom(file = url_la_county_dat)
la_county_df %>% dim(x = .)
```
The loaded dataset contains `r dim(la_county_df)[1]` observations and
`r dim(la_county_df)[2]` covariates.

Let's view the first few rows to understand the structure of the data frame.

``` {r load_data_rows}
la_county_df %>% 
  head(x = .) %>% 
  knitr::kable(x = ., format = "html", digits = 3, align = "c") %>% 
  kableExtra::kable_styling(position = "center")
```

It is already in tidy format [@wickham2014tidydata]. So we have imported the 
data correctly, given that we match the column names in Table 1 of the [@buja2019modelsasapproximationspart1] paper.

## Fitting the OLS model

We now fit an linear model of the count of homeless people (`StreetTotal`) as
the response variable, against the other covariates using Ordinary Least Squares
(OLS).

``` {r mod_fit_lm}
mod_fit <- stats::lm(formula = StreetTotal ~ ., data = la_county_df)
```

## Computing standard errors from OLS (Assuming Well Specification)

Let's first obtain the standard errors for the fitted coefficients returned from
the `lm` object. We can do this in a tidy manner using the `broom::tidy`
function applied to our fitted `lm` object, and selecting only the required
columns.

``` {r se_fit_lm}
se_lm <- broom::tidy(mod_fit) %>% 
          dplyr::select(term, std.error) %>% 
          dplyr::rename(.data = ., std.error.lm = std.error)
se_lm %>% 
  purrr::set_names(x = ., 
                   nm = c('Term', '$SE_{\\text{lin}}$')) %>% 
  knitr::kable(x = ., format = "html", digits = 3, 
               align = "c", escape = TRUE) %>% 
  kableExtra::kable_styling(position = "center")
```

```{r se_fit_lm_save_image, include=FALSE}
broom::tidy(mod_fit) %>% 
  dplyr::select(term, estimate, std.error) %>%
  purrr::set_names(x = ., 
                   nm = c('Term', '$\\widehat{\\beta}_{j}$', 
                          '$SE_{\\text{lin}}$')) %>% 
  knitr::kable(x = ., format = "latex", digits = 3, 
               align = "c", escape = FALSE) %>% 
  kableExtra::kable_styling(position = "center") %>% 
  kableExtra::as_image(x = ., width = 15, 
                       file = here::here("vignettes","figures",
                                          "output", "r00_mod_lm_fit.png"))
```


## Computing standard errors from OLS using Empirical Bootstrap

We now compute the standard errors via $B = 10^{3}$ bootstrap replications of the
dataset of the same size as the original dataset i.e. of the $B$ replications
samples with replacement $n = 505$ observations from the entire data (which 
contains $n = 505$ observations).

``` {r se_emp_fit_lm, message=FALSE, warning=FALSE}
se_emp <- maar::comp_empirical_bootstrap(mod_fit = mod_fit, B = 1000) %>%
            tidyr::unnest(boot_out) %>%
            dplyr::group_by(term) %>%
            dplyr::summarise(std.error.boot = sd(estimate))
```

This now fits, the $B =  10^{3}$ replications. let's view the output.

``` {r se_emp_fit_lm_table}
se_emp %>% 
  head(x = .) %>% 
  purrr::set_names(x = ., 
                   nm = c('Term', '$SE_{\\text{boot}}$')) %>% 
  knitr::kable(x = ., format = "html", digits = 3, 
               align = "c", escape = TRUE) %>% 
  kableExtra::kable_styling(position = "center")
```

```{r se_emp_save_image, include=FALSE}
se_emp %>% 
  head(x = .) %>% 
  purrr::set_names(x = ., 
                   nm = c('Term', '$SE_{\\text{boot}}$')) %>% 
  knitr::kable(x = ., format = "latex", digits = 3, 
               align = "c", escape = FALSE) %>% 
  kableExtra::kable_styling(position = "center",
                            latex_options = "scale_down") %>% 
  kableExtra::as_image(x = ., width = 11, 
                       file = here::here("vignettes","figures",
                                          "output", "r02_se_emp.png"),
                       density = 1000)
```

As we can see, the output is in tidy format as a `tibble` object. This makes it
much more readily amenable for additional transformations using the `tidyverse`
set of packages.

## Computing standard errors from OLS using Sandwich Estimator

Then we obtain the standard errors using the White sandwich estimator see
[@white1980heteroskedasticconsistentcovest,
@white1980usinglsapproxunknownregfuncs].

``` {r se_sand_fit_lm}
se_sand <- maar::comp_sandwich_qr_var(mod_fit) %>% diag(x = .) %>% sqrt(x = .)
se_sand
```

```{r se_sand_save_image, include=FALSE}
broom::tidy(mod_fit) %>%
  dplyr::select(term, estimate, std.error) %>% 
  tibble::add_column(std.error.sand = se_sand) %>%
  purrr::set_names(x = ., 
                   nm = c('Term', '$\\widehat{\\beta}_{j}$', 
                          '$SE_{\\text{lin}}$', '$SE_{\\text{sand}}$')) %>% 
  knitr::kable(x = ., format = "latex", digits = 3, 
               align = "c", escape = FALSE) %>% 
  kableExtra::kable_styling(position = "center") %>% 
  kableExtra::as_image(x = ., width = 15, 
                       file = here::here("vignettes","figures",
                                          "output", "r01_se_sand.png"))
```

**TODO:** We should change sandwich estimator to output a tibble with the Term.

## Comparing standard errors

We combine the standard errors into one tibble.

``` {r se_comb}
se_comb <- broom::tidy(mod_fit) %>%
            dplyr::select(term, estimate) %>%
            dplyr::left_join(x = ., y = se_lm, by = "term") %>% 
            dplyr::left_join(x = ., y = se_emp, by = "term") %>% 
            tibble::add_column(std.error.sand = se_sand)

se_comb %>%
  purrr::set_names(x = ., 
                   nm = c('Term', '$\\widehat{\\beta}_{j}$', 
                          '$SE_{\\text{lin}}$',
                          '$SE_{\\text{boot}}$', '$SE_{\\text{sand}}$')) %>% 
  knitr::kable(x = ., format = "html", digits = 3, 
               align = "c", escape = TRUE) %>% 
  kableExtra::kable_styling(position = "center")
```

```{r se_comb_save_image, include=FALSE}
se_comb %>%
  purrr::set_names(x = ., 
                   nm = c('Term', '$\\widehat{\\beta}_{j}$', 
                          '$SE_{\\text{lin}}$',
                          '$SE_{\\text{boot}}$', '$SE_{\\text{sand}}$')) %>% 
  knitr::kable(x = ., format = "latex", digits = 3, 
               align = "c", escape = FALSE) %>% 
  kableExtra::kable_styling(position = "center") %>% 
  kableExtra::as_image(x = ., width = 15, 
                       file = here::here("vignettes","figures",
                                          "output", "r05_se_comb.png"))
```

## Reproduce Table 1 from [@buja2019modelsasapproximationspart1]

We can also compute the ratios of the standard errors and the t-statistics 
as in Table 1 from [@buja2019modelsasapproximationspart1].

``` {r se_comb_t_stats}
t_stats <- se_comb %>%
            dplyr::mutate(
              rat.boot.vs.lm = std.error.boot / std.error.lm,
              rat.sand.vs.lm = std.error.sand / std.error.lm,
              rat.sand.vs.boot = std.error.sand / std.error.boot,
              t.lm = estimate / std.error.lm,
              t.boot = estimate / std.error.boot,
              t.sand = estimate / std.error.sand
            )
t_stats %>%
  purrr::set_names(x = ., 
                   nm = c("Term", '$\\widehat{\\beta}_{j}$', 
                          '$SE_{\\text{lin}}$', '$SE_{\\text{boot}}$',
                          '$SE_{\\text{sand}}$',
                          "$\\frac{SE_{\\text{boot}}}{SE_{\\text{lin}}}$",
                          "$\\frac{SE_{\\text{sand}}}{SE_{\\text{lin}}}$", 
                          "$\\frac{SE_{\\text{sand}}}{SE_{\\text{boot}}}$",
                          "$t_{\\text{lin}}$", "$t_{\\text{boot}}$", 
                          "$t_{\\text{sand}}$")) %>%
  knitr::kable(x = ., format = "html", digits = 3, 
               align = "c", escape = TRUE) %>% 
  kableExtra::kable_styling(position = "center")
```

```{r se_comb_t_stats_save_image, include=FALSE}
t_stats %>%
  purrr::set_names(x = ., 
                   nm = c("Term", '$\\widehat{\\beta}_{j}$', 
                          '$SE_{\\text{lin}}$', '$SE_{\\text{boot}}$',
                          '$SE_{\\text{sand}}$',
                          "$\\frac{SE_{\\text{boot}}}{SE_{\\text{lin}}}$",
                          "$\\frac{SE_{\\text{sand}}}{SE_{\\text{lin}}}$", 
                          "$\\frac{SE_{\\text{sand}}}{SE_{\\text{boot}}}$",
                          "$t_{\\text{lin}}$", "$t_{\\text{boot}}$", 
                          "$t_{\\text{sand}}$")) %>%
  knitr::kable(x = ., format = "latex", digits = 3, 
               align = "c", escape = FALSE) %>% 
  kableExtra::kable_styling(position = "center",
                            latex_options = "scale_down") %>% 
  kableExtra::as_image(x = ., width = 11, 
                       file = here::here("vignettes","figures",
                                          "output", "r06_se_comb_t_stats.png"),
                       density = 1000)
```


## References
