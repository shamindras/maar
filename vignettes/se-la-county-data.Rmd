---
title: "Reproducing LA County Standard Errors from [@buja2019modelsasapproximationspart1]"
author: "Riccardo Fogliato, Shamindra Shrotriya"
output: rmarkdown::html_vignette
package: maars    
bibliography: ../inst/REFERENCES.bib
resource_files:
  - figures/buja1_table1.png
vignette: >
  %\VignetteIndexEntry{Reproducing LA County Standard Errors from [@buja2019modelsasapproximationspart1]}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

``` {r  include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  linewidth = 80,
  fig.align = 'center',
  warning = FALSE,
  message = FALSE
)
```

```{r create_chunk_options, include=FALSE}
source(here::here("R", "scripts_and_filters", "create-chunk-options.R"))
source(here::here("R", "scripts_and_filters", "wrap-lines.R"))
```

## Setup and Installation

First, we'll load the `maars` package, and other `tidyverse` analysis packages.
If you are a new user, you will need to manually run the following commands in a
new in an `R` session before running the vignette code below:

``` {r install_maar, eval=FALSE}
install.packages(pkgs = c("tidyverse", "vroom", "glue", "magrittr", 
                          "knitr", "kableExtra", "remotes", "devtool"))
remotes::install_github('shamindras/maars', force = TRUE)
```
```{r load_all, include = FALSE}
devtools::load_all()
```


We will explicitly load the `tidyverse` set of packages to get access to the
`magrittr` pipe (`%>%`) operator. We will also set a global random seed for
reproducibility purposes.

``` {r load_pkgs}
library(magrittr)
set.seed(25422267)
```

For all other functions we will refer to them explicitly using the
`package::function` reference method to avoid ambiguity in the source package of
the specific function used (to avoid function name conflicts).

## Goal of Analysis

We try to replicate the results of Table 1 in
[@buja2019modelsasapproximationspart1], as shown below:

``` {r table1_img, echo=FALSE, fig.cap="Table 1 from [@buja2019modelsasapproximationspart1]", out.width = '90%'}
# knitr::include_graphics(here::here("vignettes", "figures", "buja1_table1.png"))
knitr::include_graphics(path = "figures/buja1_table1.png")
```

## Loading the data

Let's load the LA County Homeless persons data as used in
[@buja2019modelsasapproximationspart1] and briefly examine it.

``` {r load_data}
# LA County source data url, use glue to split string in easy to read format
url_la_county_dat <- glue::glue("http://www-stat.wharton.upenn.edu/~buja",
                                "STAT-961/Homeless_LA_by_Census_Tracts.csv",
                                .sep = "/")

la_county_df <- vroom::vroom(file = url_la_county_dat) # %>% dplyr::rename("MedianInc1000" = "MedianInc ($1000)")
la_county_df %>% dim(x = .)
```

Let's view the first few rows to understand the structure of the data frame.

``` {r load_data_rows}
la_county_df %>% 
  head(x = .) %>% 
  knitr::kable(x = ., format = "html", digits = 2, align = "c") %>% 
  kableExtra::kable_styling(position = "center")
```

It is already in tidy format [@wickham2014tidydata]. So we have imported the 
data correctly, given that we match the column names in Table 1 of the [@buja2019modelsasapproximationspart1] paper.

## Fitting the OLS model

We now fit an linear model of the count of homeless people (`StreetTotal`) as
the response variable, against the other covariates using Ordinary Least Squares
(OLS).

``` {r mod_fit_lm}
mod_fit <- stats::lm(formula = StreetTotal ~ ., data = la_county_df)
```


### Estimating the variance

Let's estimate the variance of the regression coefficients for the fitted model via 

* sandwich estimator (see
[@white1980heteroskedasticconsistentcovest,
@white1980usinglsapproxunknownregfuncs]). 
* (n-out-of-n) empirical bootstrap with $B=10^{3}$ replications.
* multiplier bootstrap with $B=10^{3}$ replications with Rademacher weights.
* residual bootstrap with $B=10^{3}$ replications.

To do so, we will use `comp_var`. 
The sandwich estimator of the variance is always computed by default.

```{r comp_var}
mms_fit <- comp_var(mod_fit = mod_fit,
                    boot_emp = list(B=10^3),
                    boot_mul = list(B=10^3, weights_type='rademacher'),
                    boot_res = list(B=10^3))
```

We have obtained an object of class `r class(mms_fit)`
We also have all the ingredients necessary to reproduce table 1 of the 
[@buja2019modelsasapproximationspart1] paper. 
Technically, we will only need the empirical bootstrap and sandiwch estimates.
In `maars`, the estimates, standard errors, t-statistics, and p-values can be 
obtained in a `tidy` output via `get_summary`. 
This function returns the sandwich, again, returned by default, unless specified otherwise. 
Let's first extract the summary of `mms_fit`.

```{r mms_summary}
mms_summary <- get_summary(mms_fit, boot_emp = TRUE, well_specified = TRUE)

head(mms_summary) %>%
  knitr::kable(x = ., format = "html", digits = 2, align = "c") %>% 
  kableExtra::kable_styling(position = "center")
```
As we can see, the output is in tidy format as a `tibble` object. This makes it
much more readily amenable for additional transformations using the `tidyverse`
set of packages.

We can now reformat the output of `get_summary` to make it more easily 
comparable to table 1 in the paper.
This can be achieved by first dropping the p-values (which are not needed),
followed by the computation of the ratios of the variances, and last by a `pivot_wider`.

```{r reproduce_table1}
mms_summary %>%
  # drop the p-values
  dplyr::filter(stat_type != 'p.value') %>%
  # compute the variances
  tidyr::pivot_wider(names_from = c(stat_type, var_type_abb), 
                     values_from = stat_val) %>%
  # compute the ratios
  dplyr::mutate(ratio_emp_vs_lm = std.error_emp/std.error_lm,
                ratio_sand_vs_lm = std.error_sand/std.error_emp,
                ratio_sand_vs_emp = std.error_sand/std.error_emp) %>%
  # reorder the variables
  dplyr::select(term, 
                estimate, 
                starts_with("std.error"), 
                starts_with("ratio"), 
                starts_with("statistic")) %>%
  # rename the variables
  purrr::set_names(x = ., nm = c("Term", "$\\widehat{\\beta}_{j}$", 
                                 "$SE_{\\text{lin}}$", 
                                 "$SE_{\\text{boot}}$", 
                                 "$SE_{\\text{sand}}$",
                                 "$\\frac{SE_{\\text{boot}}}{SE_{\\text{lin}}}$",
                                 "$\\frac{SE_{\\text{sand}}}{SE_{\\text{lin}}}$", 
                                 "$\\frac{SE_{\\text{sand}}}{SE_{\\text{boot}}}$",
                                 "$t_{\\text{lin}}$", 
                                 "$t_{\\text{boot}}$",
                                 "$t_{\\text{sand}}$")) %>%
  knitr::kable(
    x = ., format = "html", digits = 2,
    align = "c", escape = TRUE
  ) %>%
  kableExtra::kable_styling(position = "center")
```



## References
